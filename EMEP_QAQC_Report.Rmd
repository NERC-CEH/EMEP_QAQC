---
title: "EMEP QAQC Report - DUKEMS"
output:
  rmdformats::readthedown:
    toc_depth: 3
    fig_width: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center')
library(tidyverse)
library(fs)
library(sf)
library(lubridate)
library(furrr)
library(stars)
library(ncdf4)
library(ncdf4.helpers)
library(openair)
library(ggpubr)
library(gridExtra)
library(rnaturalearth)
library(gt)
source('emep_qaqc_user_input.R')
source('myquicktext.R')
source('emep_vars_parameters.R')
source('emep_qaqc_funcs.R')

VAR_PARAMS_LIST = get_params_list() # list of parameters for each EMEP var 
OBS_VAR_PARAMS_LIST = get_obs_var_params_list() # list of plotting params for EMEP vars used in obs-mod comparison

## create a table of observed species and their equivalent emep vars
gt_var_labeller = c(no = 'NO',
                    no2 = 'NO[2]',
                    o3 = 'O[3]',
                    ox = 'O[x]',
                    nox = 'NO[x]',
                    nh3 = 'NH[3]',
                    pm10 = 'PM[10]',
                    pm2.5 = 'PM[2.5]',
                    sox = 'SO[x]',
                    so2 = 'SO[2]',
                    voc = 'VOC',
                    co = 'CO',
                    pm25 = 'PM[2.5]',
                    pmco = 'PM[Coarse]')

future::plan(multicore)
```


\newpage
```{r run info, echo = F}
test_run_info = na.omit(c(TEST_INNER_FNAME, TEST_OUTER_FNAME)) %>% 
  path_dir() %>% 
  path_common()

ref_run_info = na.omit(c(REF_INNER_FNAME, REF_OUTER_FNAME)) %>% 
  path_dir() %>% 
  path_common()

inner_domain = extract_domain_from_fpath(TEST_INNER_FNAME)
outer_domain = extract_domain_from_fpath(TEST_OUTER_FNAME)
EMEP_domains = c(outer_domain, inner_domain)
```

## Run Info

Test path: `r test_run_info`
\
Ref path: `r ref_run_info`

## File Size
### `r extract_domain_from_fpath(TEST_OUTER_FNAME)` Domain

```{r outer_file_size, echo = F}

fsize_df = compare_file_size(TEST_OUTER_FNAME, REF_OUTER_FNAME) %>%
  format_file_size_tbl() %>% 
  tab_options(data_row.padding = px(3),
              #table.font.size = pct(95),
              table.align='left')
fsize_df
```

### `r extract_domain_from_fpath(TEST_INNER_FNAME)` Domain

```{r inner_file_size, echo = F}

fsize_df = compare_file_size(TEST_INNER_FNAME, REF_INNER_FNAME) %>%
  format_file_size_tbl() %>% 
  tab_options(data_row.padding = px(3),
              #table.font.size = pct(95),
              table.align='left')
fsize_df
```

## Emissions

```{r emission_check, echo = F}
	
###MassBudgetSummary.txt data
MBS_list = map2(c(TEST_OUTER_FNAME, TEST_INNER_FNAME), 
                c(REF_OUTER_FNAME, REF_INNER_FNAME), 
                compare_run_emissions, save_file = F, mbs_table_fname = MBS_TABLE_FNAME)

EMEP_domains = c(outer_domain, inner_domain)
MBS_plot_captions = c(str_c('Test: ', str_replace(path_file(TEST_OUTER_FNAME), '_[^_]+$', ''),'\n',
                            'Ref: ', str_replace(path_file(REF_OUTER_FNAME), '_[^_]+$', '')),
                      str_c('Test: ', str_replace(path_file(TEST_INNER_FNAME), '_[^_]+$', ''),'\n',
                            'Ref: ', str_replace(path_file(REF_INNER_FNAME), '_[^_]+$', '')))

MBS_plots = map(MBS_list, plot_MBS_diff, threshold = EMISS_DIFF_THRESHOLD) %>%
  map2(MBS_plot_captions, ~.x + labs(caption = .y) + theme(plot.caption = element_text(size = 6, face = 'italic') ))


walk2(MBS_plots, path(plots_pth_out, str_c(EMEP_domains, '_', MBS_PLOT_FNAME)),
      ~ggsave(.y, plot = .x, width = 7, height = 7, type = 'cairo'))

#for report filter only those over emission threshold
MBS_sublist = MBS_list %>%
  map(filter, rel_diff > EMISS_DIFF_THRESHOLD)
MBS_lgl = map_lgl(MBS_sublist, ~nrow(.x) == 0)

if (!MBS_lgl[1]) {
  MBS_table_O = MBS_sublist[[1]] %>% #outer domain
    select(species, rel_diff) %>%
    gt() %>% 
    cols_label(species = 'Species',
               rel_diff = 'Difference (%)') %>% 
    cols_align(align = 'right',
               columns = rel_diff) %>% 
    fmt_number(columns = rel_diff, decimals = 1) %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left')
} 

if (!MBS_lgl[2]) {
  MBS_table_I = MBS_sublist[[2]] %>% #inner domain
    select(species, rel_diff) %>%
    gt() %>% 
    cols_label(species = 'Species',
               rel_diff = 'Difference (%)') %>% 
    cols_align(align = 'right',
               columns = rel_diff) %>% 
    fmt_number(columns = rel_diff, decimals = 1) %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left')
}

###RunLog.out emissions

emiss_list = map(c(TEST_OUTER_FNAME, TEST_INNER_FNAME), compare_inv_mod_emissions, webdabEMEP_pth = WEBDABEMEP_PTH)

#determine the number of plots per page so that they fit on A4 paper
n_land = map_int(emiss_list, ~n_distinct(.x$Land))
ppp = map_int(n_land, ~case_when(.x <=10 ~ 4L, .x >= 11 && .x <= 20 ~ 2L, .x > 20 ~ 1L))

emiss_plot_list = map(emiss_list, plot_emiss_diff, threshold = EMISS_DIFF_THRESHOLD)

page_titles = map_chr(c(TEST_OUTER_FNAME, TEST_INNER_FNAME), strip_time_res) %>%
  str_c('\n\n')

emiss_plots_arranged = pmap(list(grobs = emiss_plot_list, nrow = ppp, top = page_titles),
                            marrangeGrob, ncol = 1)
out_pths = path(plots_pth_out, str_c(EMEP_domains, '_', INV_MOD_EMISS_PLOT_FNAME))

walk2(emiss_plots_arranged, out_pths, ~ggsave(filename = .y, plot = .x,paper = 'a4', height = 10, width = 7))

#for report:

#get paths with mod_inv comp tables
emiss_list_tbl_pths = map_chr(c(TEST_OUTER_FNAME, TEST_INNER_FNAME), ~paste0(extract_domain_from_fpath(.x), '_', INV_MOD_EMISS_TABLE_FNAME))
MBS_tbl_pths = map_chr(c(TEST_OUTER_FNAME, TEST_INNER_FNAME), ~paste0(extract_domain_from_fpath(.x), '_', MBS_TABLE_FNAME))

#filter only those over threshold
emiss_sublist = emiss_list %>%
  map(filter, rel_diff > EMISS_DIFF_THRESHOLD)
emiss_lgl = map_lgl(emiss_sublist, ~nrow(.x) == 0)

if (!emiss_lgl[1]) {
  em_table_O = emiss_sublist[[1]] %>%
    select(Land, pollutant, rel_diff) %>%
    mutate(pollutant = gt_var_labeller[pollutant]) %>% 
    gt() %>% 
    cols_label(Land = 'Country/Region',
               pollutant = 'Species',
               rel_diff = 'Difference (%)') %>% 
    cols_align(align = 'right',
               columns = rel_diff) %>% 
    fmt_number(columns = rel_diff, decimals = 1) %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left') %>% 
    text_transform(location = cells_body(columns = pollutant),
                   fn = function(x) {
                     str_replace_all(x, '\\[', "<sub>") %>% 
                       str_replace_all('\\]', "</sub>")
                   })
} 

if (!emiss_lgl[2]) {
  em_table_I = emiss_sublist[[2]] %>%
    select(Land, pollutant, rel_diff) %>%
    mutate(pollutant = gt_var_labeller[pollutant]) %>% 
    gt() %>% 
    cols_label(Land = 'Country/Region',
               pollutant = 'Species',
               rel_diff = 'Difference (%)') %>% 
    cols_align(align = 'right',
               columns = rel_diff) %>% 
    fmt_number(columns = rel_diff, decimals = 1) %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left') %>% 
    text_transform(location = cells_body(columns = pollutant),
                   fn = function(x) {
                     str_replace_all(x, '\\[', "<sub>") %>% 
                       str_replace_all('\\]', "</sub>")
                   })
}


```

### `r extract_domain_from_fpath(TEST_OUTER_FNAME)` Domain

Differences in emissions between the test run and EMEP inventory are saved in **`r emiss_list_tbl_pths[1]`** and plotted in **`r out_pths[1]`**. Similarly, differences in emissions between the test and reference runs are saved in **`r MBS_tbl_pths[1]`**, and plotted in **`r path(plots_pth_out, str_c(EMEP_domains, '_', MBS_PLOT_FNAME))[1]`**, respectively.

`r if(!emiss_lgl[1]) {"\\begin{comment}"}`

All test run emissions are within `r EMISS_DIFF_THRESHOLD`% of those in the EMEP emission inventory.

`r if(!emiss_lgl[1]) {"\\end{comment}"}`

`r if(emiss_lgl[1]) {"\\begin{comment}"}`

Emissions of the following species in the test run differ by more than `r EMISS_DIFF_THRESHOLD`% from those in the EMEP emission inventory:

`r if(emiss_lgl[1]) {"\\end{comment}"}`

`r if(!emiss_lgl[1]) em_table_O`

`r if(!MBS_lgl[1]) {"\\begin{comment}"}`

All test run emissions are within `r EMISS_DIFF_THRESHOLD`% of their equivalents in the reference run.

`r if(!MBS_lgl[1]) {"\\end{comment}"}`

`r if(MBS_lgl[1]) {"\\begin{comment}"}`

Emissions of the following species in the test run differ by more than `r EMISS_DIFF_THRESHOLD`% compared to their equivalents in the reference run:
`r if(MBS_lgl[1]) {"\\end{comment}"}`

`r if(!MBS_lgl[1]) MBS_table_O`


### `r extract_domain_from_fpath(TEST_INNER_FNAME)` Domain

```{r, UK_emission_tbl}
#
#show UK domain emissions
if (any(str_detect(EMEP_domains, '^UK'))) {
  UK_emiss_tbl = emiss_list[str_detect(EMEP_domains, '^UK')] %>%
    flatten_df() %>% 
    select(Land, pollutant, model) %>% 
    mutate(pollutant = gt_var_labeller[pollutant],
           across(where(is.double), ~round(.x, 1))) %>%
    pivot_wider(names_from = pollutant, values_from = model) %>% 
    gt() %>% 
    tab_header(title = md('**UK Domain Emissions**')) %>% 
    # cols_label(Land = 'Country/Region)',
    #            co = 'CO',
    #            nh3 = html('nh<sup>3</sup>'),
    #            voc = 'VOC',
    #            nox = html('NO<sup>x</sup>'),
    #            pm25 = html('PM<sup>2.5</sup>'),
    #            pmco = html('PM<sup>Coarse</sup>'),
    #            sox = html('SO<sup>x</sup>')) %>% 
    cols_align(align = 'right',
               columns = -Land) %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left')
  UK_emiss_tbl
}
```

Differences in emissions between the test run and EMEP inventory are saved in **`r emiss_list_tbl_pths[2]`** and plotted in **`r out_pths[2]`**. Similarly, differences in emissions between the test and reference runs are saved in **`r MBS_tbl_pths[2]`**, and plotted in **`r path(plots_pth_out, str_c(EMEP_domains, '_', MBS_PLOT_FNAME))[2]`**, respectively..

`r if(!emiss_lgl[2]) {"\\begin{comment}"}`

All emissions in the test run are within `r EMISS_DIFF_THRESHOLD`% of the corresponding values in the EMEP emission inventory.

`r if(!emiss_lgl[2]) {"\\end{comment}"}`

`r if(emiss_lgl[2]) {"\\begin{comment}"}`

Emissions of the following species differ by more than `r EMISS_DIFF_THRESHOLD`%  compared to those in the EMEP emission inventory:

`r if(emiss_lgl[2]) {"\\end{comment}"}`

`r if(!emiss_lgl[2]) em_table_I`

`r if(!MBS_lgl[2]) {"\\begin{comment}"}`

All emissions in the test run are within `r EMISS_DIFF_THRESHOLD`% of their equivalents in the reference run.

`r if(!MBS_lgl[2]) {"\\end{comment}"}`

`r if(MBS_lgl[2]) {"\\begin{comment}"}`

Emissions of the following species in the test run differ by more than `r EMISS_DIFF_THRESHOLD`%  compared to their equivalents in the reference run:

`r if(MBS_lgl[2]) {"\\end{comment}"}`

`r if(!MBS_lgl[2]) MBS_table_I`

## Budget & Mean Surface Concentrations (MSC)

```{r budget, include=FALSE}

emep_budget = select_vars(vars = BUDGET_VARS, var_params_list = VAR_PARAMS_LIST, param = 'budg_factor') %>% 
  load_emep_data(EMEP_BUDGET_FNAME, EMEP_BUDGET_CRS, vars = .)

if (!is.na(BUDGET_MASK_FNAME)) {
  budget_mask = st_read(BUDGET_MASK_FNAME)
} else {
  budget_mask = NULL
}

#get test file modelled year to put into output filename
mod_test_year = emep_budget[[1]] %>% 
  st_get_dimension_values('time') %>% 
  year()

emep_budget2 = emep_budget %>% 
  map(st_as_stars) %>% 
  map(apply_area_mask, area_mask = budget_mask)

budget_df = map_dfr(emep_budget2, calc_budget, VAR_PARAMS_LIST, .id = 'run') %>% 
  arrange(Variable) %>% 
  mutate(run = str_replace(run, '_[^_]+$', '')) %>% #drop characters after the last underscore (e.g. 'fullrun.nc')
  write_csv(path(tables_pth_out, paste0(path_ext_remove(BUDGET_TABLE_FNAME), '_', mod_test_year,
                                        '.', path_ext(BUDGET_TABLE_FNAME))))

#plot the difference if comparing two budget files
if (length(EMEP_BUDGET_FNAME) == 2) {
  budget_df2 = budget_df %>%
    mutate(run2 = if_else(run == str_replace(EMEP_BUDGET_FNAME[1], '_[^_]+$', ''), 'test', 'ref')) %>% 
    pivot_longer(cols = any_of(c('Total', 'Mean')), names_to = 'Stat', values_to = 'value') %>%
    pivot_wider(id_cols = c(Variable, Stat, Unit), names_from = run2, values_from = value) %>% 
    drop_na() %>% 
    mutate(abs_diff = test - ref,
           rel_diff = abs_diff/ref*100)

  budget_plot = plot_budget_diff(budget_df2, threshold = BUDGET_DIFF_THRESHOLD)
  ggsave(path(plots_pth_out, BUDGET_PLOT_FNAME), height = 10, width = 7, type = 'cairo')
  
  #for report
  v_tbl = categorise_emep_vars(budget_df2$Variable)
  v_tbl2 = v_tbl %>% 
    gt() %>% 
    fmt_missing(columns = everything(), missing_text = '') %>% 
    cols_label(emiss_vars = 'Emission Vars',
               surf_vars = 'Surface Conc Vars',
               dep_vars = 'Deposition Vars',
               misc_vars = 'Other Vars') %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left')
  
  budget_df3 = budget_df2 %>% 
    filter(rel_diff > BUDGET_DIFF_THRESHOLD)
  
  if (nrow(budget_df3 != 0)) {
    budg_table = budget_df3 %>%
      select(Variable, rel_diff) %>%
      gt() %>% 
      tab_style(style = list(cell_text(color = 'red')),
                locations = cells_body(columns = rel_diff)) %>% 
      cols_label(rel_diff = 'Difference (%)') %>% 
      cols_align(align = 'right',
                 columns = rel_diff) %>% 
      fmt_number(columns = rel_diff, decimals = 1) %>% 
      tab_options(data_row.padding = px(3),
                  #table.font.size = pct(95),
                  table.align='left')
  } 
  
}

# #plot only the test run (the first element in EMEP_BUDGET_FNAME)
dsc_plots = plot_DSC(emep_budget2[[1]], VAR_PARAMS_LIST)

page_titles = format_maps_page_title(inner_test_pth = EMEP_BUDGET_FNAME[1], run_labels = 'EMEP run') %>%
  rep(length(dsc_plots))

export = marrangeGrob(grobs = dsc_plots, nrow = 1, ncol = 1, top = substitute(page_titles[g]))
ggsave(filename = path(maps_pth_out, DSC_MAPS_FNAME), export, paper = 'a4', height = 10, width = 7)

rm(dsc_plots, emep_budget2, export)
  
```

`r if(is.na(BUDGET_MASK_FNAME)) {"\\begin{comment}"}`

Budget or MSC have been calculated and compared with the reference run using the area mask file **`r BUDGET_MASK_FNAME`** for the following EMEP variables:

`r if(is.na(BUDGET_MASK_FNAME)) {"\\end{comment}"}`

`r if(!is.na(BUDGET_MASK_FNAME)) {"\\begin{comment}"}`

Budget or MSC have been calculated and compared with the reference run using the full domain of the **`r EMEP_BUDGET_FNAME[1]`** file for the following EMEP variables:

`r if(!is.na(BUDGET_MASK_FNAME)) {"\\end{comment}"}`

`r v_tbl2`

Differences in budget & MSC between the test and reference runs are saved in **`r path(tables_pth_out, paste0(path_ext_remove(BUDGET_TABLE_FNAME), '_', mod_test_year, '.', path_ext(BUDGET_TABLE_FNAME)))`** and plotted in **`r path(plots_pth_out, BUDGET_PLOT_FNAME)`**. Maps of the test run data are plotted in **`r path(maps_pth_out, DSC_MAPS_FNAME)`**

`r if(!nrow(budget_df3) == 0) {"\\begin{comment}"}`

The budget (or MSC) for all the above variables in the test run is within `r BUDGET_DIFF_THRESHOLD`% of the corresponding values in the reference run.

`r if(!nrow(budget_df3) == 0) {"\\end{comment}"}`

`r if(nrow(budget_df3) == 0) {"\\begin{comment}"}`

The difference in budget (or MSC) between the test and reference runs is larger than `r BUDGET_DIFF_THRESHOLD`% for the following variables:

`r if(nrow(budget_df3) == 0) {"\\end{comment}"}`

`r if(!nrow(budget_df3) == 0) budg_table`

## Comparison Maps
```{r comparison maps, include=FALSE}
if (PLOT_COMPARISON_MAPS == T) {
  #collate emep_vars
  comp_map_vars = select_vars(vars = COMP_MAP_VARS, var_params_list = VAR_PARAMS_LIST, param = 'map_levs')
  
  comp_map_data = future_map(comp_map_vars, ~calculate_emep_diff(var = .x, run_labels = RUN_LABELS,
                                                              outer_test_fname = TEST_OUTER_FNAME, outer_ref_fname = REF_OUTER_FNAME,
                                                              inner_test_fname = TEST_INNER_FNAME, inner_ref_fname = REF_INNER_FNAME, emep_crs = EMEP_CRS))
  null_vars_lgl = comp_map_data %>% 
    map_lgl(is_null)
  null_vars = comp_map_vars[null_vars_lgl]
  comp_plots_list = map(comp_map_data[!null_vars_lgl], plot_comp_maps, ncl_palette_dir = PALETTE_DIR, pretty_lab = PRETTY_LABS) %>% 
    set_names(comp_map_vars[!null_vars_lgl])

  page_titles = format_maps_page_title(outer_test_pth = TEST_OUTER_FNAME,
                                       outer_ref_pth = REF_OUTER_FNAME,
                                       inner_test_pth = TEST_INNER_FNAME,
                                       inner_ref_pth = REF_INNER_FNAME,
                                       run_labels = str_c(RUN_LABELS, ' run')) %>%
    rep(length(comp_plots_list))

  export = marrangeGrob(grobs = comp_plots_list, nrow = 1, ncol = 1, top = substitute(page_titles[g]))
  ggsave(filename = path(maps_pth_out, COMP_MAPS_FNAME), export, paper = 'a4', height = 10, width = 7)
  
  #for report
  #create a table of vars in the comparison maps pdf plots
  comp_maps_vars_tbl = comp_map_data[!null_vars_lgl] %>% 
    map(names) %>% 
    map(1) %>% 
    flatten_chr() %>% 
    str_replace('_[^_]+$', '') %>% 
    categorise_emep_vars()
  
  comp_maps_vars_tbl2 = comp_maps_vars_tbl %>% 
    gt() %>% 
    fmt_missing(columns = everything(), missing_text = '') %>% 
    cols_label(emiss_vars = 'Emission Vars',
               surf_vars = 'Surface Conc Vars',
               dep_vars = 'Deposition Vars',
               misc_vars = 'Other Vars') %>% 
    tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left')
  
  #create plots for vars in COMP_MAP_VARS_REPORT
  report_map_vars = select_vars(vars = COMP_MAP_VARS_REPORT, var_params_list = VAR_PARAMS_LIST, param = 'map_levs')
  report_map_data = future_map(report_map_vars, ~calculate_emep_diff(var = .x, run_labels = RUN_LABELS,
                                                              outer_test_fname = TEST_OUTER_FNAME, outer_ref_fname = REF_OUTER_FNAME,
                                                              inner_test_fname = TEST_INNER_FNAME, inner_ref_fname = REF_INNER_FNAME, emep_crs = EMEP_CRS))
  null_vars_lgl = report_map_data %>% 
  map_lgl(is_null)
  report_plots_list = map(report_map_data[!null_vars_lgl], plot_comp_maps, ncl_palette_dir = PALETTE_DIR, pretty_lab = PRETTY_LABS) %>% 
    set_names(report_map_vars[!null_vars_lgl])
  
  for (i in seq_along(report_plots_list)) {
    report_plots_list[[i]] = report_plots_list[[i]] +
      theme(plot.margin = margin(5.5,5.5,4*5.5,5.5, "pt"))
  }
  
  if (all(!is.na(c(TEST_INNER_FNAME, REF_INNER_FNAME)))) {
    report_map_data = future_map(report_map_vars, ~calculate_emep_diff(var = .x, run_labels = RUN_LABELS,
                                                              outer_test_fname = NA, outer_ref_fname = NA,
                                                              inner_test_fname = TEST_INNER_FNAME, inner_ref_fname = REF_INNER_FNAME, emep_crs = EMEP_CRS))
      null_vars_lgl = report_map_data %>% 
      map_lgl(is_null)
      report_plots_list_i = map(report_map_data[!null_vars_lgl], plot_comp_maps, ncl_palette_dir = PALETTE_DIR, pretty_lab = PRETTY_LABS) %>% 
        set_names(report_map_vars[!null_vars_lgl])
      
    for (i in seq_along(report_plots_list_i)) {
      report_plots_list_i[[i]] = report_plots_list_i[[i]] +
        theme(plot.margin = margin(5.5,5.5,4*5.5,5.5, "pt"))
    }
  }

  
  rm(comp_plots_list, export)
  
  
}


```

```{r plot_maps, echo=FALSE, fig.height=11}
for (i in seq_along(report_plots_list)) {
  print(report_plots_list[[i]])
}

if (all(!is.na(c(TEST_INNER_FNAME, REF_INNER_FNAME)))) {
  for (i in seq_along(report_plots_list_i)) {
    print(report_plots_list_i[[i]])
  }
}


```

Comparison maps are saved in **`r path(maps_pth_out, COMP_MAPS_FNAME)`** for the following variables:
`r comp_maps_vars_tbl2`

## Observations
```{r mobs, include=FALSE}
if(COLLATE_MOBS == T) {

  obs_fname = str_replace(TEST_OBS_FNAME, '_[^_]+$', '_hour.nc') #make sure hourly data are read

  #determine pollutants to be analysed
  mobs_polls_list = map(VAR_PARAMS_LIST, 'obs') %>%
    compact()

  #create lookup table between pollutants and emep vars
  mobs_polls = names(mobs_polls_list) %>%
    set_names(flatten_chr(mobs_polls_list)) %>%
    .[OBSERVED_POLLS] %>%
    na.omit()

  #extract year from emep file
  mod_dates = get_emep_floordate(obs_fname)
  mod_year = unique(year(mod_dates$date))

  #extract latitude and longitude values from emep file
  nc = nc_open(obs_fname)
  nc_lon = ncvar_get(nc, "lon")
  nc_lat = ncvar_get(nc, "lat")
  nc_close(nc)

  #determine network of automatic sites or read file with meta of custom measurements
  if (length(AUTO_NETWORK[!file_exists(AUTO_NETWORK)]) > 0) {
    auto_sites = get_auto_meta(network = AUTO_NETWORK[!file_exists(AUTO_NETWORK)],
                               pollutant = names(mobs_polls), year = mod_year) %>%
      mutate(network = as.character(network)) %>% #must be a string for file_exists function
      mutate(year = mod_year, .after = poll_info) #just for info
  } else auto_sites = NULL

  if (length(AUTO_NETWORK[file_exists(AUTO_NETWORK)]) == 1) {
    custom_sites = read_rds(AUTO_NETWORK[file_exists(AUTO_NETWORK)])
  } else custom_sites = NULL

  sites_geo = bind_rows(auto_sites, custom_sites) %>%
    st_as_sf(coords = c('longitude', 'latitude'), crs = 4326)

  #get a 2D slice of the EMEP output to check if all sites are in the modelled domain
  #loads quicker to check on the fullrun data
  emep_slice = load_emep_data(str_replace(obs_fname, '_[^_]+$', '_fullrun.nc'),
                              emep_crs = EMEP_CRS, vars = mobs_polls[1])[[1]] %>%
    st_as_stars()

  sites_in = get_sites_in_domain(sites_geo, emep_slice)

  sites_geo = sites_geo %>%
    filter(code %in% sites_in) %>%
    mutate(longitude = st_coordinates(.)[ , 1],
           latitude = st_coordinates(.)[ , 2],
           .after = site_type_grp)

  #get the 'x' and 'y' indexes for extracting data using ncdf4 functions
  emep_indexes = future_pmap_dfr(list(longitude = sites_geo$longitude,
                                      latitude = sites_geo$latitude),
                                 get_emep_indexes, TEST_INNER_FNAME)

  sites_geo = sites_geo %>%
    mutate(i = emep_indexes$row,
           j = emep_indexes$col,
           .before = poll_info)

  #write meta data to files - rds for further use and csv for easier human check
  write_rds(sites_geo, path(data_pth_out, '00Sites_used.rds'))
  # sites_geo %>%
  #   st_drop_geometry() %>%
  #   unnest(poll_info) %>%
  #   write_csv(path(data_pth_out, '00Sites_used.csv'), na ='')

  #create a dataframe for site-pollutant iteration (enables parallel processing using furrr)
  iter_df = cross_df(list(code = sites_geo$code, poll = names(mobs_polls))) %>%
    left_join(dplyr::select(sites_geo, code, network, i, j))

  #collate modelled and observed data to a list
  mobs_tlist = future_pmap(list(site_code = iter_df$code,
                                i_index = iter_df$i,
                                j_index = iter_df$j,
                                network = iter_df$network,
                                pollutant = iter_df$poll),
                           safely(collate_obs_mod_nc), nc_pth = obs_fname,
                           poll_name_lookup = mobs_polls,
                           .options = furrr_options(seed = T)) %>%
    transpose()

  # and filter successful outcomes
  is_ok <- mobs_tlist$error %>%
    map_lgl(is_null)

  #combine data per site
  mobs_list = mobs_tlist$result[is_ok] %>%
    bind_rows() %>%
    split(.$code)

  #output iterations ending in error
  print(iter_df[!is_ok, ])

  if ('ox' %in% OBSERVED_POLLS) {
    mobs_list = mobs_list %>%
      future_map(add_ox, .options = furrr_options(seed = T))
  }

  #annual mean summary
  a_means = map_dfr(mobs_list, summarise_mobs, avg_time = 'year') %>%
    left_join(st_drop_geometry(dplyr::select(sites_geo, code, site_type_grp)))
  mobs_stats_all = modStats(a_means, statistic = MODSTATS_STATS, type = c('pollutant')) %>%
    mutate(site_type_grp = 'All')
  mobs_stats = modStats(a_means, statistic = MODSTATS_STATS, type = c('pollutant', 'site_type_grp')) %>%
    bind_rows(mobs_stats_all, .) %>%
    arrange(pollutant) %>%
    relocate(site_type_grp, .after = pollutant)
  write_csv(mobs_stats, path(tables_pth_out, MOBS_STATS_FNAME))

  if (SAVE_MOBS_RDS == T) {

    #convert to wide format for writing out to file (smaller file size)
    mobs_wide = mobs_list %>%
      map(~pivot_wider(.x, id_cols = c(date, code), names_from = c(pollutant), values_from = c(obs, mod)))

    mobs_data_pths = path(data_pth_out, paste0(names(mobs_list), '_mod_obs'), ext = 'rds')
    future_walk2(mobs_wide, mobs_data_pths, write_rds, .options = furrr_options(seed = T))
  }
  
  #for report:
  ##map of used monitoring stations
  
  country_borders = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>% 
    select(name_sort) %>% 
    st_transform(st_crs(emep_slice)) %>% 
    st_crop(emep_slice)
  
  site_plot = ggplot() +
    geom_sf(data = country_borders, fill = '#CCCCCC', color = 'black')
  
  if (str_detect(inner_domain, 'UK')) {
    UK_roads = st_read('UK_geo_data/Trunk_roads.gpkg', stringsAsFactors = F) %>% 
      st_transform(st_crs(country_borders))
    site_plot = site_plot +
      geom_sf(data = UK_roads, color = '#60676f', size = 0.2)
  }  
  
  site_plot_all = site_plot +
    geom_sf(data = st_transform(sites_geo, st_crs(country_borders)), aes(color = site_type_grp, shape = site_type_grp), stroke = 1)
  site_plot_all = theme_site_map(site_plot_all) +
    ggtitle('Location of monitoring sites')
  
  #select just sites that show time series in the report
  sites_geo_map_sub = sites_geo %>% 
  st_transform(st_crs(country_borders)) %>% 
  filter(code %in% MOBS_STATION_REPORT_TSERIES)
  
  site_plot_selected = site_plot +
    geom_sf(data = sites_geo_map_sub, aes(color = site_type_grp, shape = site_type_grp), stroke = 1) +
    ggrepel::geom_label_repel(data = sites_geo_map_sub, aes(label = code, color = site_type_grp, geometry = geometry),
                              stat = 'sf_coordinates', show.legend = F)
  site_plot_selected = theme_site_map(site_plot_selected) +
    ggtitle('Location of selected monitoring sites')

}

if (PLOT_MOBS_PDF == T) {
  if (COLLATE_MOBS != T) {

    #recreate lookup table between pollutants and emep vars
    obs_fname = str_replace(TEST_OBS_FNAME, '_[^_]+$', '_hour.nc')
    mobs_polls_list = map(VAR_PARAMS_LIST, 'obs') %>%
      compact()
    mobs_polls = names(mobs_polls_list) %>%
      set_names(flatten_chr(mobs_polls_list)) %>%
      .[OBSERVED_POLLS] %>%
      na.omit()
    mobs_polls = mobs_polls[mobs_polls %in% extract_nc_vars(obs_fname)]

    #read saved meta data
    sites_geo = read_rds(dir_ls(data_pth_out, regexp = '(S|s)ites.*\\.rds'))

    #read saved mobs data
    mobs_pths = dir_ls(data_pth_out, regexp = '\\.rds') %>%
      str_subset('(S|s)ites', negate = T)
    mobs_list = future_map(mobs_pths, read_rds) %>%
      future_map(mobs_to_long) %>%
      #temporary to ensure code column is never NA due to a previous bug
      future_map(~mutate(.x, code = if_else(is.na(code), na.omit(unique(.$code)), code)))

   #annual mean summary
   a_means = map_dfr(mobs_list, summarise_mobs, avg_time = 'year') %>%
     left_join(st_drop_geometry(dplyr::select(sites_geo, code, site_type_grp)))
   mobs_stats_all = modStats(a_means, statistic = MODSTATS_STATS, type = c('pollutant')) %>%
     mutate(site_type_grp = 'All')
   mobs_stats = modStats(a_means, statistic = MODSTATS_STATS, type = c('pollutant', 'site_type_grp')) %>%
     bind_rows(mobs_stats_all, .) %>%
     arrange(pollutant) %>%
     relocate(site_type_grp, .after = pollutant)
  }


  # #plot scatter plots of annual means (like for like - missing observations are dropped from modelled data too)
  mobs_plots = plot_annual_scatter(mobs_list = mobs_list, site_meta_df = sites_geo, poll_name_lookup = mobs_polls)
  mobs_plots = mobs_plots[order(match(mobs_plots, mobs_polls))]

  #get EMEP run fname for title on pdf plots
  run_info = format_maps_page_title(inner_test_pth = obs_fname, run_labels = 'EMEP run')

  page_titles = rep(run_info, length(mobs_plots) %/% PPP + 1)
  export = marrangeGrob(grobs = mobs_plots, nrow = PPP , ncol = 1, top = substitute(page_titles[g]))
  ggsave(filename = path(plots_pth_out, 'Annual_Mean_Scatter_all_sites.pdf'), export, paper = 'a4', height = 10, width = 7)

  #plot daily and hourly mobs per site
  future_walk(mobs_list, site_time_series_pdf3, sites_geo, out_dir = dir_create(path(plots_pth_out, 'Individual_sites')),
              ppp = PPP, run_title_info = run_info)
}

#for report:
## create a table of observed species and their equivalent emep vars
mobs_vartbl = enframe(mobs_polls) %>% 
  mutate(name = gt_var_labeller[name]) %>% 
  gt() %>%
  cols_label(name = 'Species',
             value = 'EMEP Var') %>% 
  tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left') %>% 
  text_transform(location = cells_body(columns = name),
                 fn = function(x) {
                   str_replace_all(x, '\\[', "<sub>") %>% 
                     str_replace_all('\\]', "</sub>")
                 })

mobs_stats_all_gtbl = mobs_stats_all %>% 
  select(-site_type_grp) %>% 
  mutate(pollutant = gt_var_labeller[as.character(pollutant)]) %>%
  gt() %>%
  tab_options(data_row.padding = px(3),
                #table.font.size = pct(95),
                table.align='left') %>% 
  cols_align(align = 'right',
             columns = -pollutant) %>% 
  cols_align(align = 'left',
             columns = pollutant) %>% 
  cols_label(pollutant = 'Species') %>% 
  fmt_number(columns = any_of(c('FAC2', 'NMB', 'r')),
             decimals = 2) %>% 
  fmt_number(columns = any_of(c('MB', 'RMSE')),
             decimals = 1) %>% 
  text_transform(location = cells_body(columns = pollutant),
                 fn = function(x) {
                   str_replace_all(x, '\\[', "<sub>") %>% 
                     str_replace_all('\\]', "</sub>")
                 })

#format output string based on network/custom observation configuration
custom_lgl = file_exists(AUTO_NETWORK)
if (T %in% custom_lgl) {
  if (length(AUTO_NETWORK[!custom_lgl]) == 1) {
    network_string1 = paste0(str_to_upper(AUTO_NETWORK[!custom_lgl]),
                             ' automatic network and user provided data described in ',
                             AUTO_NETWORK[custom_lgl])
  } else {
    network_string0 = str_c(AUTO_NETWORK[!custom_lgl], collapse = ', ') %>% 
      str_to_upper() %>% 
      stringi::stri_replace_last_fixed(', ', ' and ')
      
    network_string1 = paste0(network_string0,
                             ' automatic networks and user provided data described in ',
                             AUTO_NETWORK[custom_lgl])
  }
} else {
    if (length(AUTO_NETWORK[!custom_lgl]) == 1) {
    network_string1 = paste0(str_to_upper(AUTO_NETWORK[!custom_lgl]),
                             ' automatic network')
  } else {
    network_string0 = str_c(AUTO_NETWORK[!custom_lgl], collapse = ', ') %>% 
      str_to_upper() %>% 
      stringi::stri_replace_last_fixed(', ', ' and ')
      
    network_string1 = paste0(network_string0,
                             ' automatic networks')
  }
  
  #for report:
  ##map of used monitoring stations
  emep_slice = load_emep_data(str_replace(obs_fname, '_[^_]+$', '_fullrun.nc'),
                              emep_crs = EMEP_CRS, vars = mobs_polls[1])[[1]] %>%
    st_as_stars()
  
  country_borders = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>% 
    select(name_sort) %>% 
    st_transform(st_crs(emep_slice)) %>% 
    st_crop(emep_slice)
  
  site_plot = ggplot() +
    geom_sf(data = country_borders, fill = '#CCCCCC', color = 'black')
  
  if (str_detect(inner_domain, 'UK')) {
    UK_roads = st_read('UK_geo_data/Trunk_roads.gpkg', stringsAsFactors = F) %>% 
      st_transform(st_crs(country_borders))
    site_plot = site_plot +
      geom_sf(data = UK_roads, color = '#60676f', size = 0.2)
  }  
  
  site_plot_all = site_plot +
    geom_sf(data = st_transform(sites_geo, st_crs(country_borders)), aes(color = site_type_grp, shape = site_type_grp), stroke = 1)
  site_plot_all = theme_site_map(site_plot_all) +
    ggtitle('Location of monitoring sites')
  
  #select just sites that show time series in the report
  sites_geo_map_sub = sites_geo %>% 
  st_transform(st_crs(country_borders)) %>% 
  filter(code %in% MOBS_STATION_REPORT_TSERIES)
  
  site_plot_selected = site_plot +
    geom_sf(data = sites_geo_map_sub, aes(color = site_type_grp, shape = site_type_grp), stroke = 1) +
    ggrepel::geom_label_repel(data = sites_geo_map_sub, aes(label = code, color = site_type_grp, geometry = geometry),
                              stat = 'sf_coordinates', show.legend = F)
  site_plot_selected = theme_site_map(site_plot_selected) +
    ggtitle('Location of selected monitoring sites')
}

```

Hourly modelled concentrations have been compared with observations for the following species:
`r mobs_vartbl`

Observations have been taken from the `r network_string1`. A list of used sites and their meta data is saved in **`r path(data_pth_out, '00Sites_used.rds')`** and shown in the map below.

`r site_plot_all`

Model evaluation stats for all pollutants across all sites with data capture > 75% are shown in the table below and are saved in **`r path(tables_pth_out, MOBS_STATS_FNAME)`**. Additionally, scatter plots of modelled vs observed annual mean concentrations per pollutant and site type group are saved in **`r path(plots_pth_out, 'Annual_Mean_Scatter_all_sites.pdf')`**.

`r mobs_stats_all_gtbl`

### Daily mean concentrations at selected sites

```{r, mobs_time_series, echo = F, fig.height=18}

site_plot_selected

#add station codes to the list items so that stations for the report can be selected from mobs_list
if (is.null(names(mobs_list))) {
  names(mobs_list) = mobs_list %>% 
    map_chr(~pull(.x, code) %>% unique)
}
report_mobs_list = mobs_list[MOBS_STATION_REPORT_TSERIES] 

for (i in seq_along(names(report_mobs_list))) {
  rep_mobs_data = report_mobs_list[[i]]
  station_code = names(report_mobs_list)[i]
  p_title = sites_geo %>% 
    st_drop_geometry() %>% 
    filter(code == station_code) %>% 
    pull(site) %>% 
    str_c(station_code, ' (', ., ')', sep = '')
  
  p_list = vector('list', length = length(OBSERVED_POLLS))
  for (i in seq_along(OBSERVED_POLLS)) {
    p_list[[i]] = rep_mobs_data %>%
      filter(pollutant == OBSERVED_POLLS[i]) %>%
      plot_time_series2()
  }
  p_all = ggarrange(plotlist = p_list, ncol = 1) %>% 
    annotate_figure(top = text_grob(p_title, size = 16, face = 'bold'))
  print(p_all)
}

```



